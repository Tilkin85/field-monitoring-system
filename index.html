<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Monitoring System</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“‹</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: #f3f4f6;
            line-height: 1.6;
            color: #374151;
        }

        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 1.5rem;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        .section {
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        @media (max-width: 768px) {
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .alert-info {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }

        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            background-color: #f9fafb;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload-area:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }

        .linked-photo-preview {
            max-width: 100px;
            max-height: 75px;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
        }

        .card {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: white;
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #374151;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: #dbeafe;
            color: #1e40af;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin: 0.125rem;
        }

        .flex {
            display: flex;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-3 {
            margin-top: 0.75rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .text-center {
            text-align: center;
        }

        .text-red-600 {
            color: #dc2626;
        }

        .text-blue-600 {
            color: #2563eb;
        }

        .text-blue-800 {
            color: #1e40af;
        }

        .text-gray-400 {
            color: #9ca3af;
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .bg-blue-50 {
            background-color: #eff6ff;
        }

        .bg-blue-100 {
            background-color: #dbeafe;
        }

        .bg-red-100 {
            background-color: #fee2e2;
        }

        .border-blue-200 {
            border-color: #bfdbfe;
        }

        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 640px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .button-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useRef, createElement: h } = React;

        const FieldMonitoringApp = () => {
          const [formData, setFormData] = useState({
            monitor: '',
            projectName: '',
            date: '',
            projectNumber: '',
            totalHrs: '',
            totalMi: '',
            timeIn: '',
            timeOut: '',
            projectAreas: '',
            fossils: '',
            prehistoricArtifacts: '',
            historicArtifacts: '',
            architecturalFeatures: '',
            stratigraphy: '',
            grainSize: '',
            color: '',
            texture: '',
            sorting: '',
            seds: [],
            mineralization: [],
            siteConditions: '',
            excavationConditions: '',
            otherObservations: '',
            findingsReports: [{
              fieldNumber: '',
              fieldId: '',
              datum: 'NAD 83 CONUS',
              condition: '',
              contextDescription: '',
              approxAge: '',
              soils: '',
              location: '',
              fateOfLocality: '',
              linkedPhotoIds: []
            }],
            utmE: '',
            utmN: '',
            latitude: '',
            longitude: '',
            elevation: '',
            numberOfArtifacts: '',
            photoLog: [{ 
              id: 'photo_' + Date.now(), 
              photoNum: '', 
              date: '', 
              time: '', 
              gps: '', 
              direction: '', 
              description: '', 
              equipment: '', 
              photoFile: null, 
              photoPreview: null 
            }]
          });

          const [savedReports, setSavedReports] = useState(() => {
            try {
              const saved = localStorage?.getItem('fieldMonitoringReports');
              return saved ? JSON.parse(saved) : [];
            } catch (e) {
              return [];
            }
          });

          const handleInputChange = (field, value) => {
            setFormData(prev => ({ ...prev, [field]: value }));
          };

          const handleCheckboxChange = (field, value) => {
            setFormData(prev => ({
              ...prev,
              [field]: prev[field].includes(value) 
                ? prev[field].filter(item => item !== value)
                : [...prev[field], value]
            }));
          };

          const handleFindingsReportChange = (index, field, value) => {
            const newReports = [...formData.findingsReports];
            newReports[index][field] = value;
            setFormData(prev => ({ ...prev, findingsReports: newReports }));
          };

          const handlePhotoLinkChange = (reportIndex, photoId, isLinked) => {
            const newReports = [...formData.findingsReports];
            if (isLinked) {
              if (!newReports[reportIndex].linkedPhotoIds.includes(photoId)) {
                newReports[reportIndex].linkedPhotoIds.push(photoId);
              }
            } else {
              newReports[reportIndex].linkedPhotoIds = newReports[reportIndex].linkedPhotoIds.filter(id => id !== photoId);
            }
            setFormData(prev => ({ ...prev, findingsReports: newReports }));
          };

          const addFindingsReport = () => {
            setFormData(prev => ({
              ...prev,
              findingsReports: [...prev.findingsReports, {
                fieldNumber: '',
                fieldId: '',
                datum: 'NAD 83 CONUS',
                condition: '',
                contextDescription: '',
                approxAge: '',
                soils: '',
                location: '',
                fateOfLocality: '',
                linkedPhotoIds: []
              }]
            }));
          };

          const removeFindingsReport = (index) => {
            setFormData(prev => ({
              ...prev,
              findingsReports: prev.findingsReports.filter((_, i) => i !== index)
            }));
          };

          const handlePhotoLogChange = (index, field, value) => {
            const newPhotoLog = [...formData.photoLog];
            newPhotoLog[index][field] = value;
            setFormData(prev => ({ ...prev, photoLog: newPhotoLog }));
          };

          const handlePhotoUpload = (index, file) => {
            if (file && file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (e) => {
                const newPhotoLog = [...formData.photoLog];
                newPhotoLog[index].photoFile = file;
                newPhotoLog[index].photoPreview = e.target.result;
                setFormData(prev => ({ ...prev, photoLog: newPhotoLog }));
              };
              reader.readAsDataURL(file);
            } else {
              alert('Please select a valid image file (JPG, PNG, GIF, etc.)');
            }
          };

          const removePhoto = (index) => {
            const newPhotoLog = [...formData.photoLog];
            const photoId = newPhotoLog[index].id;
            newPhotoLog[index].photoFile = null;
            newPhotoLog[index].photoPreview = null;
            
            const newReports = formData.findingsReports.map(report => ({
              ...report,
              linkedPhotoIds: report.linkedPhotoIds.filter(id => id !== photoId)
            }));
            
            setFormData(prev => ({ 
              ...prev, 
              photoLog: newPhotoLog,
              findingsReports: newReports
            }));
          };

          const addPhotoEntry = () => {
            setFormData(prev => ({
              ...prev,
              photoLog: [...prev.photoLog, { 
                id: 'photo_' + Date.now(), 
                photoNum: '', 
                date: '', 
                time: '', 
                gps: '', 
                direction: '', 
                description: '', 
                equipment: '', 
                photoFile: null, 
                photoPreview: null 
              }]
            }));
          };

          const removePhotoEntry = (index) => {
            const photoId = formData.photoLog[index].id;
            
            const newReports = formData.findingsReports.map(report => ({
              ...report,
              linkedPhotoIds: report.linkedPhotoIds.filter(id => id !== photoId)
            }));
            
            setFormData(prev => ({
              ...prev,
              photoLog: prev.photoLog.filter((_, i) => i !== index),
              findingsReports: newReports
            }));
          };

          const getLinkedPhotos = (linkedPhotoIds) => {
            return formData.photoLog.filter(photo => linkedPhotoIds.includes(photo.id));
          };

          const saveReport = () => {
            const reportId = 'REPORT_' + Date.now();
            const timestamp = new Date().toLocaleString();
            
            const photoLogForStorage = formData.photoLog.map(photo => ({
              ...photo,
              photoFile: null,
              photoPreview: photo.photoPreview
            }));
            
            const newReport = {
              id: reportId,
              timestamp,
              data: { ...formData, photoLog: photoLogForStorage }
            };
            const updatedReports = [...savedReports, newReport];
            setSavedReports(updatedReports);
            try {
              if (localStorage) {
                localStorage.setItem('fieldMonitoringReports', JSON.stringify(updatedReports));
              }
              alert('Report saved as ' + reportId);
            } catch (e) {
              alert('Error saving report. Storage may be full.');
            }
          };

          const exportToJSON = () => {
            const dataStr = JSON.stringify(savedReports, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'field_monitoring_reports_' + new Date().toISOString().split('T')[0] + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
          };

          const safeValue = (value) => {
            return value || '';
          };

          const generateOriginalFormPDF = () => {
            try {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(14);
              
              doc.text('ArchaeoPaleo Resource Management Inc.', 20, 20);
              doc.setFontSize(12);
              doc.text('DAILY ARCHAEO/PALEO FIELD SUMMARY', 20, 30);
              
              doc.text('Monitor: ' + safeValue(formData.monitor), 130, 30);
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(10);
              
              doc.text('Project Name: ' + safeValue(formData.projectName), 20, 45);
              doc.text('Date: ' + safeValue(formData.date), 150, 45);
              
              doc.text('Project Number: ' + safeValue(formData.projectNumber), 20, 55);
              doc.text('Total Hrs: ' + safeValue(formData.totalHrs), 80, 55);
              doc.text('Total Mi: ' + safeValue(formData.totalMi), 120, 55);
              
              doc.text('Project Location: ' + safeValue(formData.location), 20, 65);
              doc.text('Time in: ' + safeValue(formData.timeIn), 130, 65);
              
              doc.text('Project areas monitored (number & key on weekly map):', 20, 75);
              doc.text('Time out: ' + safeValue(formData.timeOut), 130, 75);
              doc.text(safeValue(formData.projectAreas), 20, 85);
              
              let yPos = 95;
              
              doc.text('Fossils:', 20, yPos);
              doc.text(safeValue(formData.fossils), 20, yPos + 10);
              yPos += 25;
              
              doc.text('Prehistoric artifacts/ecofacts:', 20, yPos);
              doc.text(safeValue(formData.prehistoricArtifacts), 20, yPos + 10);
              doc.text("con't Y N", 180, yPos + 10);
              yPos += 25;
              
              doc.text('Historic artifacts/ecofacts:', 20, yPos);
              doc.text(safeValue(formData.historicArtifacts), 20, yPos + 10);
              doc.text("con't Y N", 180, yPos + 10);
              yPos += 25;
              
              doc.text('Architectural features:', 20, yPos);
              doc.text(safeValue(formData.architecturalFeatures), 20, yPos + 10);
              doc.text("con't Y N", 180, yPos + 10);
              yPos += 25;
              
              doc.text('Stratigraphy: (turbidites / bioturbation / channels / beds / laminations / massive / contacts / erosional', 20, yPos);
              doc.text('gradational / faults / slides / photos)', 20, yPos + 8);
              doc.text(safeValue(formData.stratigraphy), 20, yPos + 18);
              yPos += 35;
              
              doc.text('Lithology: Grain size: (' + safeValue(formData.grainSize) + ') Color: ' + safeValue(formData.color) + 
                      ' Texture: ' + safeValue(formData.texture) + ' Sorting: ' + safeValue(formData.sorting), 20, yPos);
              yPos += 15;
              
              const sedsText = formData.seds.length > 0 ? formData.seds.join(' ') : '';
              doc.text('Sed: ( mud/s silt/s sand/s lime/s shale conglomerate breccia concretions ) ' + sedsText, 20, yPos);
              doc.text("con't Y N", 180, yPos);
              yPos += 15;
              
              const minText = formData.mineralization.length > 0 ? formData.mineralization.join(' / ') : '';
              doc.text('Mineralization: caliche / siliceous / paleosol / alluvium / lag deposits / ' + minText, 20, yPos);
              yPos += 20;
              
              doc.text('Site conditions & personnel: ( non-compliance / hazards / weather / safety concerns / visitors)', 20, yPos);
              doc.text(safeValue(formData.siteConditions), 20, yPos + 10);
              yPos += 25;
              
              doc.text('Excavation conditions: (status / equipment / cuts / access)', 20, yPos);
              doc.text(safeValue(formData.excavationConditions), 20, yPos + 10);
              yPos += 25;
              
              doc.text('Other Observations & Comments:', 20, yPos);
              doc.text(safeValue(formData.otherObservations), 20, yPos + 10);
              doc.text("con't Y N", 180, yPos + 10);
              yPos += 25;
              
              if (yPos > 240) {
                doc.addPage();
                yPos = 20;
              }
              
              formData.findingsReports.forEach((finding, index) => {
                if (index > 0) {
                  doc.addPage();
                  yPos = 20;
                }
                
                doc.text('FINDINGS REPORT ' + (index + 1), 20, yPos);
                yPos += 15;
                
                doc.text('Field Number: ' + safeValue(finding.fieldNumber) + 
                        ' Field ID: ' + safeValue(finding.fieldId) + 
                        ' Datum: ' + safeValue(finding.datum), 20, yPos);
                yPos += 15;
                
                doc.text('Condition: ( poor / fair / good / excellent / damaged / partial / whole ) ' + safeValue(finding.condition), 20, yPos);
                yPos += 15;
                
                doc.text('Arti/eco-fact context description: ' + safeValue(finding.contextDescription) + 
                        ' Approx. age: ' + safeValue(finding.approxAge), 20, yPos);
                yPos += 15;
                
                doc.text('Soils: ' + safeValue(finding.soils), 20, yPos);
                yPos += 15;
                
                doc.text('Location: (pads / cuts /landmarks) ' + safeValue(finding.location), 20, yPos);
                yPos += 15;
                
                doc.text('Fate of Locality: (accessible / buried / graded away ) ' + safeValue(finding.fateOfLocality), 20, yPos);
                yPos += 15;
                
                if (finding.linkedPhotoIds.length > 0) {
                  const linkedPhotos = getLinkedPhotos(finding.linkedPhotoIds);
                  doc.text('Linked Photos: ' + linkedPhotos.map(p => p.photoNum || 'Photo ' + (formData.photoLog.indexOf(p) + 1)).join(', '), 20, yPos);
                  yPos += 15;
                }
              });
              
              doc.text('Coordinates: UTM ' + safeValue(formData.utmE) + 'E/' + safeValue(formData.utmN) + 'N// ' +
                      'Lat. N' + safeValue(formData.latitude) + ' Long.W' + safeValue(formData.longitude) + 
                      ' Elev' + safeValue(formData.elevation), 20, yPos);
              yPos += 15;
              
              doc.text('Number of arti/eco-facts: specimens / paperbags / boxes / samples / bags of matrix: ' + 
                      safeValue(formData.numberOfArtifacts), 20, yPos);
              
              if (formData.photoLog.some(photo => photo.photoNum || photo.description)) {
                doc.addPage();
                yPos = 20;
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('PHOTO LOG', 20, yPos);
                yPos += 15;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                
                formData.photoLog.forEach((photo, index) => {
                  if (photo.photoNum || photo.description) {
                    doc.text('Photo #: ' + safeValue(photo.photoNum) + 
                            ' Date: ' + safeValue(photo.date) + 
                            ' Time: ' + safeValue(photo.time), 20, yPos);
                    yPos += 10;
                    
                    doc.text('GPS: ' + safeValue(photo.gps) + 
                            ' Direction: ' + safeValue(photo.direction) + 
                            ' Equipment: ' + safeValue(photo.equipment), 20, yPos);
                    yPos += 10;
                    
                    doc.text('Description: ' + safeValue(photo.description), 20, yPos);
                    yPos += 15;
                    
                    if (yPos > 250) {
                      doc.addPage();
                      yPos = 20;
                    }
                  }
                });
              }
              
              doc.save('ArchaeoPaleo_Field_Summary_' + new Date().toISOString().split('T')[0] + '.pdf');
              
            } catch (error) {
              alert('PDF generation failed: ' + error.message);
              console.error('PDF Error:', error);
            }
          };

          const clearForm = () => {
            if (confirm('Clear all form data? This will also remove all uploaded photos and findings reports.')) {
              setFormData({
                monitor: '',
                projectName: '',
                date: '',
                projectNumber: '',
                totalHrs: '',
                totalMi: '',
                timeIn: '',
                timeOut: '',
                projectAreas: '',
                fossils: '',
                prehistoricArtifacts: '',
                historicArtifacts: '',
                architecturalFeatures: '',
                stratigraphy: '',
                grainSize: '',
                color: '',
                texture: '',
                sorting: '',
                seds: [],
                mineralization: [],
                siteConditions: '',
                excavationConditions: '',
                otherObservations: '',
                findingsReports: [{
                  fieldNumber: '',
                  fieldId: '',
                  datum: 'NAD 83 CONUS',
                  condition: '',
                  contextDescription: '',
                  approxAge: '',
                  soils: '',
                  location: '',
                  fateOfLocality: '',
                  linkedPhotoIds: []
                }],
                utmE: '',
                utmN: '',
                latitude: '',
                longitude: '',
                elevation: '',
                numberOfArtifacts: '',
                photoLog: [{ 
                  id: 'photo_' + Date.now(), 
                  photoNum: '', 
                  date: '', 
                  time: '', 
                  gps: '', 
                  direction: '', 
                  description: '', 
                  equipment: '', 
                  photoFile: null, 
                  photoPreview: null 
                }]
              });
